<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å¸å®‰ Web3 é’±åŒ… ç¬¬6 æœŸ Prime Sale Pre-TGE (ESP)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --c-bg:#f9f9f9;
      --c-card:#fff;
      --c-text:#222;
      --c-sub:#6b7280;
      --c-primary:#0078d4;
      --c-primary-dark:#005fa3;
      --c-success:#16a34a;
      --c-error:#dc2626;
      --c-refund:#0284c7;
      --c-warn:#f59e0b;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --c-bg:#111827;
        --c-card:#1f2937;
        --c-text:#f3f4f6;
        --c-sub:#9ca3af
      }
    }
    *{box-sizing:border-box;margin:0}
    body{
      font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
      background:var(--c-bg);color:var(--c-text)
    }
    .container{
      max-width:760px;margin:40px auto;padding:34px;background:var(--c-card);border-radius:18px;
      box-shadow:0 10px 24px rgba(0,0,0,.08)
    }
    h2{color:var(--c-primary);text-align:center;margin-bottom:8px}

    /* åˆçº¦åœ°å€é»˜è®¤ä¸ºéšè—ï¼ˆä¿ç•™ DOMï¼‰ã€‚éœ€è¦å±•ç¤ºå¯æŠŠ display:none å»æ‰ */
    .subline{display:none}

    label{display:block;margin:14px 0 8px;font-weight:700}
    .note{font-size:13px;color:var(--c-sub);margin-left:4px}

    input,select{
      width:100%;
      padding:12px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:10px;
      background:var(--c-card);
      color:var(--c-text)
    }
    input[readonly]{background:linear-gradient(90deg,#f3f4f6,#fff);cursor:default}

    button{
      width:100%;
      padding:13px;
      font-size:16px;
      background:var(--c-primary);
      color:#fff;
      border:none;
      border-radius:10px;
      margin-top:18px;
      cursor:pointer;
      transition:background .2s
    }
    button:hover{background:var(--c-primary-dark)}

    .row{display:flex;gap:12px}
    .col{flex:1}

    .progress-container{margin-top:22px}
    .progress-bg{background:#e5e7eb;height:14px;border-radius:10px;overflow:hidden}
    .progress-bar{background:var(--c-primary);height:100%;width:0%;transition:width .4s}
    .countdown{margin-top:6px;text-align:right;font-size:14px;color:var(--c-sub)}

    .result{
      margin-top:22px;
      padding:18px;
      border-radius:14px;
      border:1px solid #d1d5db;
      background:var(--c-bg)
    }
    .result p{margin:8px 0;font-size:15px;line-height:1.45}

    .highlight{font-weight:700}
    .success{color:var(--c-success);font-weight:700}
    .deduct{color:var(--c-error);font-weight:700}
    .refund{color:var(--c-refund);font-weight:700}

    .updateHint{text-align:right;font-size:13px;color:var(--c-sub);margin-top:10px}

    .error-banner{
      display:none;margin-bottom:18px;padding:10px 14px;border-radius:10px;
      background:var(--c-error);color:#fff;font-size:14px
    }

    .footer{margin-top:28px;text-align:center;font-size:14px;color:var(--c-sub)}
    .footer a{color:var(--c-primary);text-decoration:none}
    .footer a:hover{text-decoration:underline}

    /* âœ… ä¸¤ä¸ªä»·æ ¼æ¡†åŒå®½åŒé«˜ï¼šå…³é”®æ˜¯ align-items:stretch */
    .priceBox{
      display:flex;
      gap:12px;
      align-items:stretch;
      margin-top:12px
    }
    .priceItem{
      flex:1;
      padding:10px;
      border-radius:10px;
      border:1px solid #e6edf3;
      background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)
    }
    .priceItem .v{font-weight:700;font-size:16px}
    .priceItem .t{font-size:12px;color:var(--c-sub);margin-top:6px}

    /* âœ… å‚è€ƒä»·ä¸‹é¢çš„ã€Œä»·æ ¼æ¥æºã€é“¾æ¥ï¼ˆæ¢è¡Œ + å¯ç‚¹å‡»ï¼‰ */
    .premarketLink, .premarketLink:visited{
      display:block;
      margin-top:4px;
      color:inherit;
      text-decoration:underline;
      text-underline-offset:3px;
      font-weight:700;
    }
    .premarketLink:hover{ color: var(--c-primary); }

    .countdownAuto{font-size:13px;color:var(--c-sub);margin-top:8px;text-align:center}

    .ended-banner{
      display:none;margin-top:14px;padding:12px;border-radius:10px;
      background:rgba(245,158,11,.08);border:1px solid var(--c-warn)
    }
    .muted{opacity:.55;pointer-events:none;user-select:none}

    /* ===== æ•™ç¨‹é“¾æ¥ï¼šå±…ä¸­ + é»„è‰²ç¯æ³¡å›¾æ ‡ + æ›´ç´§å‡‘ ===== */
    .tutorials{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .tutorial-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:800;
      font-size:15px;
      color:var(--c-primary);
      padding:6px 10px;
      border-radius:10px;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .tutorial-link:hover{ background:rgba(0,120,212,.06); }
    .tutorial-link .ico{
      width:18px;height:18px;line-height:0;
      display:inline-flex;
      color:var(--c-warn);
      transform:translateY(1px);
    }

    /* ===== é»„è‰²æç¤ºæ¡ï¼šæŒ‰é’®æ°¸è¿œå›ºå®šåœ¨å³ä¾§ ===== */
    .hintBanner{
      margin-top:14px;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.55);
      display:grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items:center;
      column-gap:12px;
      width:100%;
    }
    .hintLeft{
      display:flex;
      align-items:flex-start;
      gap:6px;
      min-width:0;
    }
    .hintPrefix{
      color:var(--c-warn);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      margin-top:1px;
    }
    .hintMsg{
      color:var(--c-warn);
      font-weight:800;
      font-size:12px;
      line-height:1.35;
      white-space:normal;
      word-break:break-word;
    }
    .hintRight{
      justify-self:end;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .hintBtn{
      color:var(--c-warn);
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      white-space:nowrap;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(245,158,11,.55);
      background:rgba(255,255,255,.60);
    }
    .hintBtn:hover{ text-decoration:underline; }
    .hintSub{
      text-align:right;
      font-size:12.5px;
      color:var(--c-sub);
      font-weight:700;
      line-height:1.35;
    }
    .hintCode{
      font-size:13.5px;
      font-weight:900;
      color:var(--c-warn);
    }
    @media (max-width:560px){
      .hintBanner{ grid-template-columns: 1fr; row-gap:10px; }
      .hintRight{ align-items:stretch; }
      .hintBtn{ width:100%; text-align:center; }
      .hintSub{ text-align:center; }
    }

    /* ===== åªçœ‹åˆ©æ¶¦ï¼šå°æŒ‰é’® ===== */
    .viewRow{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:10px;
    }
    .miniBtn{
      width:auto;
      padding:8px 12px;
      font-size:13px;
      border-radius:999px;
      background:rgba(0,120,212,.10);
      color:var(--c-primary);
      border:1px solid rgba(0,120,212,.35);
      margin-top:0;
    }
    .miniBtn:hover{ background:rgba(0,120,212,.18); }
    .miniHint{font-size:12px;color:var(--c-sub);font-weight:700}

    /* ===== åªçœ‹åˆ©æ¶¦æ¨¡å¼ï¼šéšè—éå…³é”®åŒºåŸŸ ===== */
    body.profitOnlyMode #airdropSection{ display:none !important; }
    body.profitOnlyMode #priceBox{ display:none !important; }
    body.profitOnlyMode .tutorials{ display:none !important; }
    body.profitOnlyMode .hintBanner{ display:none !important; }
    /* ä¿ç•™å€’è®¡æ—¶ + åˆ·æ–° + è¾“å…¥ï¼Œéšè—ç»“æœé‡Œé™¤åˆ©æ¶¦å¤–å†…å®¹ */
    body.profitOnlyMode #resultBox p:not(.profitLine),
    body.profitOnlyMode #resultBox hr{ display:none !important; }
    body.profitOnlyMode #resultBox{
      padding:26px;
    }
    body.profitOnlyMode #resultBox .profitLine{
      margin:0;
      text-align:center;
      font-size:18px;
      line-height:1.6;
    }
    body.profitOnlyMode #profitUSD{
      font-size:32px;
      display:inline-block;
      margin-left:6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="errBanner" class="error-banner"></div>

    <h2>å¸å®‰ Web3 é’±åŒ… ç¬¬6 æœŸ Prime Sale Pre-TGE (ESP)</h2>

    <!-- åˆçº¦åœ°å€ï¼ˆéšè—ï¼Œä»…å†…éƒ¨ä½¿ç”¨ï¼›éœ€è¦å±•ç¤ºå¯æŠŠ .subline çš„ display:none ç§»é™¤ï¼‰ -->
    <div class="subline">åˆçº¦ï¼š<a id="contractLink" href="#" target="_blank" rel="noopener noreferrer">â€”</a></div>

    <input id="targetAddress" type="hidden" value="0x68297d833d16e2e4e9807512164334ba6c4699da" />

    <div class="row">
      <div class="col">
        <label>æŠ•å…¥ BNB <span class="note">å•äººä¸Šé™ 3 BNB</span></label>
        <input id="userAmount" type="number" step="0.01" value="3" min="0" max="3" inputmode="decimal" />
      </div>
      <div class="col">
        <label>åˆ·æ–°é¢‘ç‡ (ç§’)<span class="note">æœ€å°‘ 5 ç§’</span></label>
        <input id="refreshSec" type="number" step="1" value="10" min="5" inputmode="numeric" />
      </div>
    </div>

    <label>ç›˜å‰ä»· (USDT)<span class="note">é»˜è®¤è‡ªåŠ¨è¯»å–ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰</span></label>
    <input id="tokenPrice" type="number" step="0.000001" value="0.097580" min="0" inputmode="decimal" />

    <div id="airdropSection">
      <label>é¢„è®¡ç©ºæŠ•æ€»é¢ (USDT)<span class="note">ï¼ˆæ ¹æ®ç›˜å‰ä»·æ¨ç®—ï¼‰</span></label>
      <input id="airdropUSD" type="number" step="1" value="5254683" readonly />
      <div class="note" id="airdropFmt">â€”</div>
    </div>

    <div class="priceBox" id="priceBox" aria-hidden="false">
      <div class="priceItem">
        <div class="v" id="bnbPriceV">â€”</div>
        <div class="t">å½“å‰ BNB ä»·æ ¼ï¼ˆUSDTï¼‰</div>
      </div>
      <div class="priceItem">
        <div class="v" id="labPriceV">â€”</div>
        <div class="t">
          ESP ç›˜å‰å‚è€ƒä»·
          <a class="premarketLink" href="https://www.binance.com/zh-CN/futures/ESPUSDT" target="_blank" rel="noopener noreferrer">
            ä»·æ ¼æ¥æºï¼šå¸å®‰åˆçº¦æ¥å£ ESPUSDTï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
          </a>
        </div>
      </div>
    </div>

    <div class="countdownAuto" id="autoRefreshCountdown">ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼šâ€” ç§’</div>

    <button id="refreshBtn">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>

    <div class="viewRow">
      <button id="profitOnlyBtn" class="miniBtn" type="button" aria-pressed="false">ğŸ‘ åªçœ‹åˆ©æ¶¦ï¼šå…³</button>
      <div class="miniHint">ï¼ˆå†æ¬¡ç‚¹å‡»æ¢å¤å…¨éƒ¨ï¼‰</div>
    </div>

    <div class="updateHint" id="lastUpdateHint">â€”</div>

    <!-- ===== æ•™ç¨‹é“¾æ¥ ===== -->
    <div class="tutorials">
      <a class="tutorial-link" href="https://x.com/0xXIAOc/status/1929136552757830056" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9.6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>é“¾ä¸Šå€ŸBNBæ•™ç¨‹</span>
      </a>

      <a class="tutorial-link" href="https://x.com/0xXIAOc/status/1977584958295392288" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9 .6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>äº¤æ˜“æ‰€å€ŸBNBæ•™ç¨‹</span>
      </a>

      <a class="tutorial-link" href="https://x.com/0xXIAOc/status/2001254000516346195?s=20" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9 .6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>å¸å®‰é’±åŒ…å€ŸBNBæ•™ç¨‹</span>
      </a>
    </div>

    <!-- ===== é»„è‰²æç¤ºæ¡ + é‚€è¯·ç  ===== -->
    <div class="hintBanner">
      <div class="hintLeft">
        <span class="hintPrefix">æç¤ºï¼š</span>
        <span class="hintMsg">
          22ç‚¹ç»“æŸåï¼Œæœªè¢«ç”¨äºè®¤è´­çš„BNBå¯ä»¥é€€å›ã€‚<br>
          è·å¾—çš„ä»£å¸ä¸Šçº¿åå¯åœ¨äº¤æ˜“æ‰€å–å‡ºã€‚
        </span>
      </div>
      <div class="hintRight">
        <a class="hintBtn" href="https://web3.binance.com/zh-CN/referral?ref=XIAOCC" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
          å¸å®‰é’±åŒ…ç»‘å®šé‚€è¯·ç  æ‰‹ç»­è´¹ç«‹å‡30%
        </a>
        <div class="hintSub">
          ç‚¹å‡»ä¸Šæ–¹ä¸€é”®ç»‘å®šé‚€è¯·ç <br>
          <span class="hintCode">é‚€è¯·ç ï¼šXIAOCC</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressSection">
      <div class="progress-bg"><div class="progress-bar" id="progressBar"></div></div>
      <div class="countdown" id="countdownText">å€’è®¡æ—¶åŠ è½½ä¸­â€¦</div>
    </div>

    <div class="result" id="resultBox" hidden>
      <p>ğŸ“¦ å½“å‰åœ°å€ BNB ä½™é¢ï¼š<span class="highlight" id="bnbBalance">â€”</span></p>
      <p>ğŸ¯ å‹Ÿé›†èµ„é‡‘ï¼š<span class="highlight" id="targetBNBShow">â€”</span> BNB</p>
      <p>ğŸ”¥ è¶…å‹Ÿå€æ•°ï¼š<span class="highlight" id="multiplier">â€”</span></p>
      <p>
        ğŸ’° å‡ºå”®ä»£å¸æ•°é‡ï¼š53,850,000 ä¸ª ESPï¼ˆå æ€»ä¾›åº”é‡çš„ 1.5%ï¼‰
        <span id="bonusInfo" style="display:none"></span>
      </p>
      <hr>
      <p>
        ğŸš€ ä½ æŠ•å…¥ <span class="highlight" id="userInput">â€”</span> BNBï¼ˆå æ¯” <span class="highlight" id="percent">â€”</span>%ï¼‰<br>
        å¯è·å¾— <span class="success" id="tokenAmt">â€”</span> æš ESP<span id="bonusLabel">ï¼ˆå«èµ é€ï¼‰</span> â‰ˆ <span class="success" id="usdValue">â€”</span>
      </p>
      <p>ğŸ’¸ å®é™…æ‰£æ¬¾ï¼š<span class="deduct" id="principalBNB">â€”</span> BNB â‰ˆ <span class="deduct" id="principalUSD">â€”</span></p>

      <p class="profitLine">ğŸ“ˆ åˆ©æ¶¦ï¼š<span class="highlight" id="profitUSD">â€”</span></p>

      <p>ğŸ”„ é€€å› BNBï¼š<span class="refund" id="refundBNB">â€”</span> BNB</p>
    </div>

    <!-- ä¿ç•™ DOMï¼Œä½†ä¸æ˜¾ç¤ºï¼ˆæŒ‰ä½ è¦æ±‚ï¼‰ -->
    <div class="ended-banner" id="endedMsg">æ´»åŠ¨å·²ç»“æŸï¼Œæ•°æ®å·²é”å®šã€‚</div>
  </div>

  <div class="footer">
    ä½œè€…ï¼š<a href="https://x.com/0xXIAOc" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">@0xXIAOc</a>
    &nbsp;|&nbsp;
    <a href="https://t.me/xiaoccaac" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">âœˆï¸åŠ å…¥Alphaäº¤æµç¾¤</a>
  </div>

  <script>
    // ==== é…ç½®ï¼ˆESP ä¸“åœºï¼‰====
    const CONFIG = {
      SYMBOL: 'ESP',
      TOTAL_TARGET_BNB: 5857.45,
      TOTAL_TOKENS: 53_850_000,
      MAX_PER_USER_BNB: 3,

      // âœ… èµ é€å…³é—­ï¼šä¸ç¿»å€
      BONUS_MULTIPLIER: 1,

      // âœ… æ—¶é—´ï¼š2æœˆ10æ—¥ 20:00-22:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
      START_TIME: new Date('2026-02-10T20:00:00+08:00'),
      END_TIME: new Date('2026-02-10T22:00:00+08:00'),

      PRICE_CACHE_MS: 60_000,
      PRICE_DISPLAY_REFRESH_MS: 30_000,

      PRICE_APIS: [
        'https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT',
        'https://fapi.binance.com/fapi/v1/ticker/price?symbol=BNBUSDT',
        'https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd',
        'https://min-api.cryptocompare.com/data/price?fsym=BNB&tsyms=USD'
      ],

      // âœ… ESP ç›˜å‰ä»·æ¥å£ï¼ˆUSDTï¼‰
      TOKEN_PRICE_API: 'https://fapi.binance.com/fapi/v2/ticker/price?symbol=ESPUSDT',

      RPC_NODES: [
        'https://bsc-dataseed.binance.org/',
        'https://bsc-dataseed1.defibit.io/',
        'https://bsc-dataseed4.defibit.io/',
        'https://bsc-dataseed1.ninicoin.io/'
      ],

      // âœ… 21:59 é”å®šï¼ˆç»“æŸå‰ 1 åˆ†é’Ÿï¼‰
      FINAL_REFRESH_BEFORE_END_MS: 60_000
    };

    const $ = id => document.getElementById(id);

    const els = {
      userAmount: $('userAmount'),
      tokenPrice: $('tokenPrice'),
      airdropUSD: $('airdropUSD'),
      airdropFmt: $('airdropFmt'),
      refreshSec: $('refreshSec'),
      refreshBtn: $('refreshBtn'),
      lastUpdateHint: $('lastUpdateHint'),

      bnbBalance: $('bnbBalance'),
      multiplier: $('multiplier'),
      userInput: $('userInput'),
      percent: $('percent'),
      tokenAmt: $('tokenAmt'),
      usdValue: $('usdValue'),
      principalBNB: $('principalBNB'),
      principalUSD: $('principalUSD'),

      profitUSD: $('profitUSD'),
      refundBNB: $('refundBNB'),

      resultBox: $('resultBox'),
      countdownText: $('countdownText'),
      progressBar: $('progressBar'),
      errBanner: $('errBanner'),
      targetAddress: $('targetAddress'),
      targetBNBShow: $('targetBNBShow'),

      bnbPriceV: $('bnbPriceV'),
      labPriceV: $('labPriceV'),
      priceBoxDiv: $('priceBox'),
      autoRefreshCountdown: $('autoRefreshCountdown'),
      endedMsg: $('endedMsg'),
      contractLink: $('contractLink'),

      profitOnlyBtn: $('profitOnlyBtn'),

      bonusInfo: $('bonusInfo'),
      bonusLabel: $('bonusLabel')
    };

    const STATE = {
      bnbUSDT: 0,
      tokenUSDT: 0,
      profitOnly: false
    };

    const fmt = (n, d = 0) => Number(n).toLocaleString('zh-CN', { maximumFractionDigits: d });
    const TZ = 'Asia/Shanghai';

    const lockAtMs = () => CONFIG.END_TIME.getTime() - (CONFIG.FINAL_REFRESH_BEFORE_END_MS || 60_000);
    const isLocked = () => Date.now() >= lockAtMs();
    const isEnded = () => Date.now() >= CONFIG.END_TIME.getTime();

    async function fetchJSON(url, options = {}, timeoutMs = 8000){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);

      try{
        const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
        if(!res.ok){
          const msg = res.status === 429
            ? 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼ˆ429ï¼‰ï¼Œè¯·é™ä½åˆ·æ–°é¢‘ç‡'
            : `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return await res.json();
      }catch(e){
        if(e.name === 'AbortError') throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•æˆ–æ›´æ¢èŠ‚ç‚¹');
        throw e;
      }finally{
        clearTimeout(t);
      }
    }

    function computeAirdropUSDFromTokenPrice(tokenPrice){
      const tokens = CONFIG.TOTAL_TOKENS || 0;
      const price = Number(tokenPrice) || 0;
      return tokens * (CONFIG.BONUS_MULTIPLIER || 1) * price;
    }

    function computePrice(){
      const tokenP = +els.tokenPrice.value || 0;
      const computedAirdrop = computeAirdropUSDFromTokenPrice(tokenP);
      els.airdropUSD.value = Math.round(computedAirdrop);
      els.airdropFmt.textContent = computedAirdrop ? ('â‰ˆ ' + fmt(computedAirdrop/1e4) + ' ä¸‡ USDT') : 'â€”';
    }

    function syncLabPriceDisplay(){
      const p = +els.tokenPrice.value || 0;
      els.labPriceV.textContent = p ? (p.toFixed(6) + ' USDT') : 'â€”';
    }

    async function getBNBPrice(){
      const cache = JSON.parse(localStorage.getItem('bnbP')||'{}');
      if(cache.v && Date.now()-cache.t < CONFIG.PRICE_CACHE_MS) return cache.v;

      for(const url of CONFIG.PRICE_APIS){
        try{
          const d = await fetchJSON(url, {}, 7000);
          const v = Number(d?.price ?? d?.binancecoin?.usd ?? d?.USD ?? 0);
          if(v){
            localStorage.setItem('bnbP', JSON.stringify({v, t:Date.now()}));
            return v;
          }
        }catch{}
      }
      return 0;
    }

    async function getTokenPrice(){
      const key = `tokP_${CONFIG.SYMBOL}`;
      const cache = JSON.parse(localStorage.getItem(key)||'{}');
      if(cache.v && Date.now()-cache.t < CONFIG.PRICE_CACHE_MS) return cache.v;

      try{
        const d = await fetchJSON(CONFIG.TOKEN_PRICE_API, {}, 7000);
        const p = Number(d?.price);
        if(p){
          localStorage.setItem(key, JSON.stringify({v:p, t:Date.now()}));
          return p;
        }
      }catch{}
      return 0;
    }

    async function updatePriceDisplay(){
      try{
        const [bnbUSDT, tokP] = await Promise.all([getBNBPrice(), getTokenPrice()]);
        STATE.bnbUSDT = bnbUSDT || 0;
        if(tokP) STATE.tokenUSDT = tokP;

        els.bnbPriceV.textContent = STATE.bnbUSDT ? (fmt(STATE.bnbUSDT,4) + ' USDT') : 'â€”';

        if(tokP && !els.tokenPrice.dataset.userEdited){
          els.tokenPrice.value = Number(tokP).toFixed(6);
          computePrice();
        }
        syncLabPriceDisplay();
      }catch(e){
        console.error('updatePriceDisplay error', e);
      }
    }

    function weiHexToBNB(weiHex){
      try{
        const wei = BigInt(weiHex);
        const base = 10n ** 18n;
        const intPart = wei / base;
        const fracPart = wei % base;
        const fracStr = fracPart.toString().padStart(18,'0').slice(0, 6);
        return Number(`${intPart.toString()}.${fracStr}`);
      }catch{
        return 0;
      }
    }

    async function fetchBalance(addr){
      if(!addr) return 0;
      const body = JSON.stringify({jsonrpc:'2.0',method:'eth_getBalance',params:[addr,'latest'],id:1});
      for(const node of CONFIG.RPC_NODES){
        try{
          const {result} = await fetchJSON(node,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body
          }, 7000);
          return weiHexToBNB(result);
        }catch{}
      }
      return 0;
    }

    // ===== è‡ªåŠ¨åˆ·æ–° =====
    let refreshIntervalMs = Math.max(+els.refreshSec.value||10,5) * 1000;
    let nextRefreshAt = 0;
    let refreshTimeoutId = null;
    let countdownTimerId = null;
    let finalRefreshTimerId = null;

    function stopAutoRefreshTimers(){
      if(refreshTimeoutId) clearTimeout(refreshTimeoutId);
      if(countdownTimerId) clearInterval(countdownTimerId);
      refreshTimeoutId = null;
      countdownTimerId = null;

      if(finalRefreshTimerId) clearTimeout(finalRefreshTimerId);
      finalRefreshTimerId = null;
    }

    function scheduleNextRefresh(){
      if(isEnded() || isLocked() || document.hidden) return;

      refreshIntervalMs = Math.max(+els.refreshSec.value||10,5) * 1000;
      nextRefreshAt = Date.now() + refreshIntervalMs;

      refreshTimeoutId = setTimeout(async ()=>{
        await refresh(false);
        scheduleNextRefresh();
      }, refreshIntervalMs);
    }

    function updateCountdownDisplay(){
      if(isLocked()){
        els.autoRefreshCountdown.textContent = 'æ•°æ®å·²é”å®šï¼šä¿æŒ 21:59 æ›´æ–°ç»“æœ';
        return;
      }
      if(isEnded()){
        els.autoRefreshCountdown.textContent = 'æ•°æ®å·²é”å®šï¼šä¿æŒ 21:59 æ›´æ–°ç»“æœ';
        return;
      }
      const s = Math.max(0, Math.ceil((nextRefreshAt - Date.now()) / 1000));
      els.autoRefreshCountdown.textContent = `ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼š${s} ç§’`;
    }

    function startAutoRefreshTimers(){
      stopAutoRefreshTimers();

      if(isLocked() || isEnded()){
        applyLockState();
        updateCountdownDisplay();
        return;
      }

      scheduleNextRefresh();
      updateCountdownDisplay();
      countdownTimerId = setInterval(updateCountdownDisplay, 250);

      scheduleFinalRefreshBeforeEnd();
    }

    function resetAutoRefresh(){
      if(isEnded() || isLocked() || document.hidden) return;
      startAutoRefreshTimers();
    }

    function scheduleFinalRefreshBeforeEnd(){
      if(finalRefreshTimerId) clearTimeout(finalRefreshTimerId);
      finalRefreshTimerId = null;

      const lockAt = lockAtMs();
      const now = Date.now();
      if(now >= lockAt || now >= CONFIG.END_TIME.getTime()){
        applyLockState();
        return;
      }

      finalRefreshTimerId = setTimeout(async ()=>{
        // 21:59 å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ï¼ˆå…è®¸å¼ºåˆ¶ï¼Œä¸å— locked é™åˆ¶ï¼‰ï¼Œç„¶åé”å®š
        await refresh(false, true);
        applyLockState();
      }, lockAt - now);
    }

    // ===== ç»“æŸ/é”å®šçŠ¶æ€ =====
    let lockStateApplied = false;
    function applyLockState(){
      if(lockStateApplied) return;
      lockStateApplied = true;

      stopAutoRefreshTimers();

      els.autoRefreshCountdown.textContent = 'æ•°æ®å·²é”å®šï¼šä¿æŒ 21:59 æ›´æ–°ç»“æœ';

      // ç¦æ­¢ä»»ä½•åˆ·æ–°ç›¸å…³æ“ä½œï¼ˆç¡®ä¿ 21:59 åä¸ä¼šå†å˜ï¼‰
      els.refreshBtn.classList.add('muted');
      els.refreshBtn.disabled = true;
      els.refreshSec.disabled = true;

      // ä¸æ˜¾ç¤º ended bannerï¼ˆæŒ‰ä½ è¦æ±‚ï¼‰
      if(els.endedMsg) els.endedMsg.style.display = 'none';
    }

    let endStateApplied = false;
    function applyEndState(){
      if(endStateApplied) return;
      endStateApplied = true;

      applyLockState();

      els.countdownText.textContent = 'å·²ç»“æŸ';
      if(els.endedMsg) els.endedMsg.style.display = 'none';
    }

    // ===== æ ¸å¿ƒæ¸²æŸ“ =====
    let latestDep = 0;

    function loadCachedDepIfAny(){
      const key = `dep_${CONFIG.SYMBOL}`;
      try{
        const cache = JSON.parse(localStorage.getItem(key) || '{}');
        if(cache?.v){
          latestDep = Number(cache.v) || latestDep;
          if(cache?.t){
            const dt = new Date(cache.t);
            if(!isNaN(dt.getTime())){
              els.lastUpdateHint.textContent = 'æœ€åæ›´æ–°ï¼š' + dt.toLocaleTimeString('zh-CN',{hour12:false});
            }
          }
        }
      }catch{}
    }

    function saveDepCache(dep){
      const key = `dep_${CONFIG.SYMBOL}`;
      try{
        localStorage.setItem(key, JSON.stringify({ v: dep, t: Date.now() }));
      }catch{}
    }

    async function render(dep = latestDep){
      if(isLocked()) applyLockState();
      if(isEnded()) applyEndState();

      computePrice();
      syncLabPriceDisplay();

      let user = +els.userAmount.value || 0;
      if(user > CONFIG.MAX_PER_USER_BNB){
        user = CONFIG.MAX_PER_USER_BNB;
        els.userAmount.value = user.toFixed(2);
      }

      const price = +els.tokenPrice.value || 0;
      const bnbUSDT = STATE.bnbUSDT || 0;
      const target = CONFIG.TOTAL_TARGET_BNB;

      els.targetBNBShow.textContent = target ? fmt(target,2) : 'â€”';

      if(!(user && price && bnbUSDT && dep && target)){
        els.resultBox.hidden = true;
        return;
      }

      const share = user / dep;
      const baseTokens = share * CONFIG.TOTAL_TOKENS;
      const tokens = baseTokens * (CONFIG.BONUS_MULTIPLIER || 1);

      const principal = Math.min(share * target, user);
      const refund = Math.max(user - principal, 0);
      const multi = dep / target;

      els.bnbBalance.textContent = fmt(dep,4);
      els.multiplier.textContent = fmt(multi,2);
      els.userInput.textContent = fmt(user,2);
      els.percent.textContent = fmt(share*100,4);
      els.tokenAmt.textContent = fmt(tokens,2);
      els.usdValue.textContent = fmt(tokens*price,2) + ' USDT';

      els.principalBNB.textContent = fmt(principal,4);
      els.principalUSD.textContent = fmt(principal*bnbUSDT,2) + ' USDT';

      const profit = (tokens * price) - (principal * bnbUSDT);
      els.profitUSD.textContent = fmt(profit, 2) + ' USDT';
      els.profitUSD.classList.remove('success', 'deduct');
      els.profitUSD.classList.add(profit >= 0 ? 'success' : 'deduct');

      els.refundBNB.textContent = fmt(refund,4);
      els.resultBox.hidden = false;
    }

    // ===== åˆ·æ–°ï¼ˆforce=true ç”¨äº 21:59 å¼ºåˆ¶åˆ·æ–°ï¼‰=====
    let refreshing = false;
    let pendingForcedRefresh = false;

    async function refresh(manual=false, force=false){
      if(refreshing){
        if(force) pendingForcedRefresh = true;
        return;
      }

      // 21:59 åä¸å†æ‹‰æ•°æ®ï¼ˆé™¤é forceï¼‰
      if(!force && (isLocked() || isEnded())){
        loadCachedDepIfAny();
        await render(latestDep);
        if(isLocked()) applyLockState();
        if(isEnded()) applyEndState();
        return;
      }

      refreshing = true;
      els.refreshBtn.disabled = true;
      if(manual) els.errBanner.style.display = 'none';

      try{
        // 21:59 å¼ºåˆ¶é‚£æ¬¡ä¹Ÿä¼šæ›´æ–°ä»·æ ¼+ä½™é¢
        await updatePriceDisplay();
        const dep = await fetchBalance(els.targetAddress.value);
        saveDepCache(dep);
        await render(dep);
        els.lastUpdateHint.textContent = 'æœ€åæ›´æ–°ï¼š' + new Date().toLocaleTimeString('zh-CN',{hour12:false});
      }catch(e){
        if(manual){
          els.errBanner.textContent = e?.message || 'ç½‘ç»œé”™è¯¯';
          els.errBanner.style.display = 'block';
        }
        console.error(e);
      }finally{
        els.refreshBtn.disabled = false;
        refreshing = false;

        if(pendingForcedRefresh){
          pendingForcedRefresh = false;
          setTimeout(() => refresh(false, true), 0);
        }
      }
    }

    function formatRangeForCN(st, et){
      const getNum = (date, opt) =>
        new Intl.DateTimeFormat('zh-CN', { timeZone: TZ, ...opt })
          .format(date)
          .replace(/\D/g, '');

      const m = getNum(st, { month: 'numeric' });
      const d = getNum(st, { day: 'numeric' });

      const tFmt = new Intl.DateTimeFormat('zh-CN', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false });
      const ts = tFmt.format(st);
      const te = tFmt.format(et);

      return `${m}æœˆ${d}æ—¥ ${ts}-${te}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰`;
    }

    function tick(){
      const stMs = CONFIG.START_TIME.getTime();
      const etMs = CONFIG.END_TIME.getTime();
      const nowMs = Date.now();

      if(nowMs < stMs){
        els.countdownText.textContent = `æ´»åŠ¨æœªå¼€å§‹ï¼š${formatRangeForCN(CONFIG.START_TIME, CONFIG.END_TIME)}`;
        els.progressBar.style.width = '0%';
        return;
      }

      if(nowMs >= etMs){
        els.progressBar.style.width = '100%';
        applyEndState();
        return;
      }

      const diff = etMs - nowMs;
      const hours = Math.floor(diff/3.6e6);
      const mins = Math.floor((diff%3.6e6)/6e4);
      const secs = Math.floor((diff%6e4)/1e3);

      const txt = hours>0
        ? `${hours} å°æ—¶ ${mins} åˆ†`
        : (mins>0 ? `${mins} åˆ† ${secs} ç§’` : `${(diff/1e3).toFixed(1)} ç§’`);

      els.countdownText.textContent = `å‰©ä½™æ—¶é—´ï¼š${txt}`;
      const pct = ((nowMs - stMs) / (etMs - stMs) * 100);
      els.progressBar.style.width = (pct>100?100: pct<0?0:pct).toFixed(2) + '%';
    }

    function applyInterval(){
      const sec = Math.max(+els.refreshSec.value||10,5);
      refreshIntervalMs = sec * 1000;
      if(!isEnded() && !isLocked()){
        resetAutoRefresh();
      }
    }

    // ===== åªçœ‹åˆ©æ¶¦åŠŸèƒ½ =====
    function setProfitOnlyMode(on){
      STATE.profitOnly = !!on;
      document.body.classList.toggle('profitOnlyMode', STATE.profitOnly);
      els.profitOnlyBtn.setAttribute('aria-pressed', STATE.profitOnly ? 'true' : 'false');
      els.profitOnlyBtn.textContent = STATE.profitOnly ? 'ğŸ‘ åªçœ‹åˆ©æ¶¦ï¼šå¼€' : 'ğŸ‘ åªçœ‹åˆ©æ¶¦ï¼šå…³';
      localStorage.setItem('profitOnlyMode', STATE.profitOnly ? '1' : '0');
    }

    els.tokenPrice.addEventListener('input', ()=>{
      els.tokenPrice.dataset.userEdited = '1';
      computePrice();
      syncLabPriceDisplay();
      render();
    });

    els.userAmount.addEventListener('input', ()=>{
      let v = +els.userAmount.value || 0;
      if(v > CONFIG.MAX_PER_USER_BNB){
        v = CONFIG.MAX_PER_USER_BNB;
        els.userAmount.value = v.toFixed(2);
      }
      render();
    });

    els.refreshSec.addEventListener('change', applyInterval);

    els.refreshBtn.addEventListener('click', async ()=>{
      await refresh(true);
      resetAutoRefresh();
    });

    els.profitOnlyBtn.addEventListener('click', ()=>{
      setProfitOnlyMode(!STATE.profitOnly);
      if(STATE.profitOnly && !els.resultBox.hidden){
        els.resultBox.scrollIntoView({ behavior:'smooth', block:'center' });
      }
    });

    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        stopAutoRefreshTimers();
      }else{
        if(!isEnded() && !isLocked()){
          startAutoRefreshTimers();
        }else{
          applyLockState();
          if(isEnded()) applyEndState();
        }
      }
    });

    window.addEventListener('load', async ()=>{
      // æ¢å¤â€œåªçœ‹åˆ©æ¶¦â€çŠ¶æ€
      const saved = localStorage.getItem('profitOnlyMode') === '1';
      setProfitOnlyMode(saved);

      // åˆçº¦é“¾æ¥
      const addr = els.targetAddress.value;
      if(els.contractLink){
        els.contractLink.href = `https://bscscan.com/address/${addr}`;
        els.contractLink.textContent = addr;
      }

      // èµ é€æ–‡æ¡ˆæ§åˆ¶ï¼ˆBONUS_MULTIPLIER=1 ä¼šéšè—ï¼‰
      const hasBonus = (CONFIG.BONUS_MULTIPLIER || 1) > 1;
      els.bonusLabel.style.display = hasBonus ? 'inline' : 'none';
      if(hasBonus){
        els.bonusInfo.style.display = 'inline';
        els.bonusInfo.innerHTML = `<br>ğŸ èµ é€è§„åˆ™ï¼šæ¯è®¤è´­ 1 æšé¢å¤–èµ é€ 1 æšï¼ˆæœ€ç»ˆåˆ°å¸=å‡ºå”®åˆ†é…Ã—${CONFIG.BONUS_MULTIPLIER}ï¼‰`;
      }else{
        els.bonusInfo.style.display = 'none';
      }

      computePrice();
      syncLabPriceDisplay();

      // è‹¥å·²ç»é”å®š/ç»“æŸï¼šåªä»ç¼“å­˜æ¢å¤ï¼ˆä¸å†æ‹‰é“¾ä¸Šï¼‰
      if(isLocked() || isEnded()){
        loadCachedDepIfAny();
        await render(latestDep);
        applyLockState();
        if(isEnded()) applyEndState();
      }else{
        await updatePriceDisplay();
        startAutoRefreshTimers();
        await refresh(false);
      }

      setInterval(tick, 500);

      // ä»·æ ¼æ˜¾ç¤ºï¼šé”å®šåä¹Ÿåœæ­¢æ›´æ–°ï¼ˆä¿è¯ 21:59 æ•°æ®ä¸å˜ï¼‰
      setInterval(()=>{
        if(!isEnded() && !isLocked()) updatePriceDisplay();
      }, CONFIG.PRICE_DISPLAY_REFRESH_MS);
    });
  </script>
</body>
</html>
