<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>币安 Web3 钱包第21期 IDO 上线 ($CUDIS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 建议上线时启用严格 CSP，示例： -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https: data:;"> -->
  <style>
    body{
      font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
      background:#f0f2f5;margin:0;padding:0
    }
    .container{
      max-width:640px;margin:40px auto;background:#fff;
      padding:30px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08)
    }
    h2{color:#0078d4;text-align:center;margin-bottom:25px}
    label{display:block;margin:16px 0 6px;font-weight:700;color:#333}
    input,select{
      width:100%;padding:10px;font-size:15px;border:1px solid #ccc;
      border-radius:8px;box-sizing:border-box
    }
    button{
      width:100%;padding:12px;font-size:16px;background:#0078d4;color:#fff;
      border:none;border-radius:8px;margin-top:20px;cursor:pointer;
      transition:background-color .2s
    }
    button:hover{background:#005fa3}
    .progress-container{margin-top:30px}
    .progress-bg{background:#eee;height:14px;border-radius:8px;overflow:hidden}
    .progress-bar{background:#0078d4;height:100%;width:0%;transition:width .5s}
    .countdown{text-align:right;margin-top:5px;font-size:14px;color:#888}
    .result{
      background:#f9fafb;margin-top:30px;padding:20px;border-radius:12px;
      border:1px solid #ddd
    }
    .result p{margin:10px 0;font-size:15px}
    .highlight{color:#d32f2f;font-weight:700}
    .success{color:#2e7d32;font-weight:700}
    .tutorial-link{
      display:block;text-align:center;margin-top:15px;font-weight:700;
      text-decoration:none;color:#0078d4
    }
    .tutorial-link:hover{text-decoration:underline}
    .updateHint{text-align:right;font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <h2>币安 Web3 钱包第21期 IDO 上线 ($CUDIS)</h2>

    <label>选择代币</label>
    <select id="tokenSelect">
      <option value="CUDIS">CUDIS</option>
    </select>

    <!-- 主池地址，隐藏可改 -->
    <input id="targetAddress" class="hidden"
           value="0x7276202abf2b9f1ef84178c7edf3333bd1ec82a5" style="display:none"/>

    <label>投入 BNB</label>
    <input id="userAmount" type="number" step="0.01" value="3"/>

    <label>代币单价（单位：USD，可自定义修改，默认 0.09）</label>
    <input id="tokenPrice" type="number" step="0.0001" value="0.09"/>

    <button id="refreshBtn" onclick="manualRefresh()">🔄 刷新数据</button>
    <div class="updateHint" id="lastUpdateHint">—</div>

    <a class="tutorial-link"
       href="https://x.com/0xXIAOc/status/1930520238988333193" target="_blank">
      📘 提前授权 CUDIS 教程入口
    </a>

    <div class="progress-container">
      <div class="progress-bg">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="countdown" id="countdownText">倒计时加载中…</div>
    </div>

    <div class="result" id="resultBox" style="display:none">
      <p>📦 当前地址 BNB 余额：<span class="highlight" id="bnbBalance"></span></p>
      <p>🎯 募集目标：453.37 BNB</p>
      <p>🔥 当前进度：<span class="highlight" id="multiplier"></span> 倍超募</p>
      <p>💰 总销售量：20,000,000 CUDIS</p>
      <hr>
      <p>
        🚀 你投入 <span class="highlight" id="userInput"></span> BNB
        （占比 <span class="highlight" id="percent"></span>%）<br>
        可获得 <span class="success" id="cudisAmount"></span> 枚 CUDIS
        ≈ <span class="success" id="usdValue"></span> USD
      </p>
    </div>
  </div>

<script>
/* ──────────── 全局常量 ──────────── */
const CONFIG = {
  TOTAL_TARGET_BNB: 453.37,
  TOTAL_TOKENS: 20_000_000,
  START_TIME: new Date('2025-06-05T16:00:00+08:00'),
  END_TIME:   new Date('2025-06-05T18:00:00+08:00'),
  REFRESH_INTERVAL_MS: 30_000,
  RPC_NODES: [
    'https://bsc-dataseed.binance.org/',
    'https://bsc-dataseed1.defibit.io/',
    'https://bsc-dataseed1.ninicoin.io/'
  ]
};

/* ──────────── DOM 缓存 ──────────── */
const els = {
  targetAddress : document.getElementById('targetAddress'),
  userAmount    : document.getElementById('userAmount'),
  tokenPrice    : document.getElementById('tokenPrice'),
  bnbBalance    : document.getElementById('bnbBalance'),
  multiplier    : document.getElementById('multiplier'),
  userInput     : document.getElementById('userInput'),
  percent       : document.getElementById('percent'),
  cudisAmount   : document.getElementById('cudisAmount'),
  usdValue      : document.getElementById('usdValue'),
  resultBox     : document.getElementById('resultBox'),
  countdownText : document.getElementById('countdownText'),
  progressBar   : document.getElementById('progressBar'),
  refreshBtn    : document.getElementById('refreshBtn'),
  lastUpdateHint: document.getElementById('lastUpdateHint')
};

/* ──────────── 工具函数 ──────────── */
// 将 BigInt wei 转为字符串形式的 BNB，保留 4 位小数
const formatWeiToBNB = (weiBig) => {
  const intPart  = (weiBig / 10n**18n).toString();
  const fracPart = (weiBig % 10n**18n).toString().padStart(18,'0').slice(0,4);
  return `${intPart}.${fracPart}`.replace(/\.?0+$/,''); // 去掉多余 0
};

const now = () => new Date().getTime();

/* ──────────── 核心逻辑 ──────────── */
// 从节点池顺序请求，直到成功
async function fetchBalanceWithFallback(address){
  for(const rpc of CONFIG.RPC_NODES){
    try{
      const controller = new AbortController();
      const timeout = setTimeout(()=>controller.abort(), 7_000);
      const payload = {
        jsonrpc:'2.0',method:'eth_getBalance',
        params:[address,'latest'],id:1
      };
      const res = await fetch(rpc,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload),
        signal:controller.signal
      });
      clearTimeout(timeout);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(data.result) return BigInt(data.result);
    }catch(e){
      console.warn(`⚠ 节点 ${rpc} 失败：`,e.message);
    }
  }
  throw new Error('所有 RPC 节点均不可用');
}

/* 更新余额 & 计算分配 */
async function updateBalanceAndCalc(){
  const address   = els.targetAddress.value.trim();
  const userInput = parseFloat(els.userAmount.value);
  const price     = parseFloat(els.tokenPrice.value);

  if(!address || isNaN(userInput) || userInput<=0 || isNaN(price) || price<=0){
    alert('请输入有效投入金额和代币单价');
    return;
  }

  try{
    els.refreshBtn.disabled = true;
    els.refreshBtn.textContent = '⏳ 刷新中…';

    const wei = await fetchBalanceWithFallback(address);
    const bnbStr = formatWeiToBNB(wei);
    const bnbNum = parseFloat(bnbStr);

    els.bnbBalance.textContent = `${bnbStr} BNB`;

    // 倍数与占比
    const multiple = bnbNum / CONFIG.TOTAL_TARGET_BNB;
    els.multiplier.textContent = multiple.toFixed(2);

    const percent = Math.min((userInput / CONFIG.TOTAL_TARGET_BNB)*100, 100);
    els.percent.textContent = percent.toFixed(2);

    // 预计获得 CUDIS
    const tokens = (userInput / CONFIG.TOTAL_TARGET_BNB) * CONFIG.TOTAL_TOKENS;
    els.cudisAmount.textContent = tokens.toFixed(2);
    els.usdValue.textContent    = (tokens * price).toFixed(2);

    els.userInput.textContent = userInput.toFixed(2);
    els.resultBox.style.display = 'block';

    // 更新时间提示
    const t = new Date();
    els.lastUpdateHint.textContent =
      `最后更新时间：${t.toLocaleTimeString('zh-CN',{hour12:false})}`;
  }catch(err){
    console.error(err);
    alert(`查询失败：${err.message}`);
  }finally{
    els.refreshBtn.disabled = false;
    els.refreshBtn.textContent = '🔄 刷新数据';
  }
}

/* 倒计时与进度条 */
function updateCountdown(){
  const tNow = now();
  if(tNow < CONFIG.START_TIME.getTime()){
    els.countdownText.textContent = '活动未开始';
    els.progressBar.style.width = '0%';
  }else if(tNow >= CONFIG.END_TIME.getTime()){
    els.countdownText.textContent = '已结束';
    els.progressBar.style.width = '100%';
  }else{
    const diff   = CONFIG.END_TIME.getTime() - tNow;
    const hours  = Math.floor(diff / 36e5);
    const mins   = Math.floor((diff % 36e5)/6e4);
    els.countdownText.textContent = `剩余时间：${hours}小时 ${mins}分`;

    const total  = CONFIG.END_TIME.getTime() - CONFIG.START_TIME.getTime();
    const percent= ((tNow - CONFIG.START_TIME.getTime()) / total)*100;
    els.progressBar.style.width = percent.toFixed(2)+'%';
  }
}

/* 手动刷新触发 */
function manualRefresh(){
  updateBalanceAndCalc();
}

/* ──────────── 初始化 ──────────── */
window.addEventListener('load',()=>{
  updateBalanceAndCalc();          // 首次查询
  updateCountdown();
  setInterval(updateBalanceAndCalc, CONFIG.REFRESH_INTERVAL_MS); // 周期刷新
  setInterval(updateCountdown, 1_000);                           // 倒计时动画
});
</script>
</body>
</html>
