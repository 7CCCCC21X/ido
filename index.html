<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å¸å®‰ Web3 é’±åŒ… ç¬¬42æœŸç‹¬å®¶TGE (IR)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --c-bg:#f9f9f9; --c-card:#fff; --c-text:#222; --c-sub:#6b7280;
      --c-primary:#0078d4; --c-primary-dark:#005fa3; --c-success:#16a34a;
      --c-error:#dc2626; --c-refund:#0284c7; --c-warn:#f59e0b;
    }
    @media(prefers-color-scheme:dark){
      :root{ --c-bg:#111827; --c-card:#1f2937; --c-text:#f3f4f6; --c-sub:#9ca3af }
    }
    *{box-sizing:border-box;margin:0}
    body{
      font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
      background:var(--c-bg);color:var(--c-text)
    }
    .container{
      max-width:760px;margin:40px auto;padding:34px;background:var(--c-card);border-radius:18px;
      box-shadow:0 10px 24px rgba(0,0,0,.08)
    }
    h2{color:var(--c-primary);text-align:center;margin-bottom:8px}

    /* åˆçº¦åœ°å€é»˜è®¤ä¸ºéšè—ï¼ˆä¿ç•™ DOMï¼‰ã€‚éœ€è¦å±•ç¤ºå¯æŠŠ display:none å»æ‰ */
    .subline{display:none}

    label{display:block;margin:14px 0 8px;font-weight:700}
    .note{font-size:13px;color:var(--c-sub);margin-left:4px}

    input,select{
      width:100%;
      padding:12px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:10px;
      background:var(--c-card);
      color:var(--c-text)
    }
    input[readonly]{background:linear-gradient(90deg,#f3f4f6,#fff);cursor:default}

    button{
      width:100%;
      padding:13px;
      font-size:16px;
      background:var(--c-primary);
      color:#fff;
      border:none;
      border-radius:10px;
      margin-top:18px;
      cursor:pointer;
      transition:background .2s
    }
    button:hover{background:var(--c-primary-dark)}

    .row{display:flex;gap:12px}
    .col{flex:1}

    .progress-container{margin-top:22px}
    .progress-bg{background:#e5e7eb;height:14px;border-radius:10px;overflow:hidden}
    .progress-bar{background:var(--c-primary);height:100%;width:0%;transition:width .4s}
    .countdown{margin-top:6px;text-align:right;font-size:14px;color:var(--c-sub)}

    .result{
      margin-top:22px;
      padding:18px;
      border-radius:14px;
      border:1px solid #d1d5db;
      background:var(--c-bg)
    }
    .result p{margin:8px 0;font-size:15px;line-height:1.45}
    .highlight{font-weight:700}
    .success{color:var(--c-success);font-weight:700}
    .deduct{color:var(--c-error);font-weight:700}
    .refund{color:var(--c-refund);font-weight:700}

    .updateHint{text-align:right;font-size:13px;color:var(--c-sub);margin-top:10px}
    .error-banner{
      display:none;margin-bottom:18px;padding:10px 14px;border-radius:10px;
      background:var(--c-error);color:#fff;font-size:14px
    }

    .footer{margin-top:28px;text-align:center;font-size:14px;color:var(--c-sub)}
    .footer a{color:var(--c-primary);text-decoration:none}
    .footer a:hover{text-decoration:underline}

    .priceBox{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:12px}
    .priceItem{
      flex:1;
      padding:10px;
      border-radius:10px;
      border:1px solid #e6edf3;
      background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)
    }
    .priceItem .v{font-weight:700;font-size:16px}
    .priceItem .t{font-size:12px;color:var(--c-sub);margin-top:6px}

    .countdownAuto{font-size:13px;color:var(--c-sub);margin-top:8px;text-align:center}

    .ended-banner{
      display:none;margin-top:14px;padding:12px;border-radius:10px;
      background:rgba(245,158,11,.08);border:1px solid var(--c-warn)
    }
    .muted{opacity:.55;pointer-events:none;user-select:none}

    /* ===== æ•™ç¨‹é“¾æ¥ï¼šå±…ä¸­ + é»„è‰²ç¯æ³¡å›¾æ ‡ + æ›´ç´§å‡‘ ===== */
    .tutorials{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .tutorial-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:800;
      font-size:15px;
      color:var(--c-primary);
      padding:6px 10px;
      border-radius:10px;

      /* âœ… æ°¸ä¹…ä¸‹åˆ’çº¿ï¼ˆä¸‹æ¨ªçº¿ï¼‰ */
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .tutorial-link:hover{
      background:rgba(0,120,212,.06);
    }
    .tutorial-link .ico{
      width:18px;height:18px;line-height:0;
      display:inline-flex;
      color:var(--c-warn);
      transform:translateY(1px);
    }

    /* ===== é»„è‰²æç¤ºæ¡ï¼šæŒ‰é’®æ°¸è¿œå›ºå®šåœ¨å³ä¾§ï¼ˆæŒ‰æˆªå›¾ç®­å¤´ä½ç½®ï¼‰ ===== */
    .hintBanner{
      margin-top:14px;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.55);

      display:grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items:center;
      column-gap:12px;

      width:100%;
    }

    .hintLeft{
      display:flex;
      align-items:flex-start;
      gap:6px;
      min-width:0;
    }

    .hintPrefix{
      color:var(--c-warn);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      margin-top:1px;
    }

    .hintMsg{
      color:var(--c-warn);
      font-weight:800;
      font-size:12px;
      line-height:1.35;
      white-space:normal;
      word-break:break-word;
    }

    .hintRight{
      justify-self:end;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }

    .hintBtn{
      color:var(--c-warn);
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      white-space:nowrap;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(245,158,11,.55);
      background:rgba(255,255,255,.60);
    }
    .hintBtn:hover{ text-decoration:underline; }

    .hintSub{
      text-align:right;
      font-size:12.5px;
      color:var(--c-sub);
      font-weight:700;
      line-height:1.35;
    }
    .hintCode{
      font-size:13.5px;
      font-weight:900;
      color:var(--c-warn);
    }

    @media (max-width:560px){
      .hintBanner{
        grid-template-columns: 1fr;
        row-gap:10px;
      }
      .hintRight{
        align-items:stretch;
      }
      .hintBtn{
        width:100%;
        text-align:center;
      }
      .hintSub{
        text-align:center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="errBanner" class="error-banner"></div>

    <h2>å¸å®‰ Web3 é’±åŒ… ç¬¬42æœŸç‹¬å®¶TGE (IR)</h2>

    <!-- åˆçº¦åœ°å€ï¼ˆéšè—ï¼Œä»…å†…éƒ¨ä½¿ç”¨ï¼›éœ€è¦å±•ç¤ºå¯æŠŠ .subline çš„ display:none ç§»é™¤ï¼‰ -->
    <div class="subline">åˆçº¦ï¼š<a id="contractLink" href="#" target="_blank" rel="noopener">â€”</a></div>
    <input id="targetAddress" type="hidden" value="0xa3ea0e2f9f2c4b702275ad957a799276672f7dd1" />

    <div class="row">
      <div class="col">
        <label>æŠ•å…¥ BNB <span class="note">å•äººä¸Šé™ 3 BNB</span></label>
        <input id="userAmount" type="number" step="0.01" value="3" min="0" max="3" />
      </div>
      <div class="col">
        <label>åˆ·æ–°é¢‘ç‡ (ç§’)<span class="note">æœ€å°‘ 5 ç§’</span></label>
        <input id="refreshSec" type="number" step="1" value="10" min="5" />
      </div>
    </div>

    <label>ä»£å¸å•ä»· (USDT)<span class="note">é»˜è®¤ 0.2ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹</span></label>
    <input id="tokenPrice" type="number" step="0.000001" value="0.2" min="0" />

    <label>é¢„è®¡ç©ºæŠ•æ€»é¢ (USDT)<span class="note">æ ¹æ®å•ä»·æ¨ç®—</span></label>
    <input id="airdropUSD" type="number" step="1" value="0" readonly />
    <div class="note" id="airdropFmt">â€”</div>

    <div class="priceBox" id="priceBox" aria-hidden="false">
      <div class="priceItem">
        <div class="v" id="bnbPriceV">â€”</div>
        <div class="t">å½“å‰ BNB ç¾å…ƒä»·æ ¼ï¼ˆUSDï¼‰</div>
      </div>
      <div class="priceItem">
        <div class="v" id="labPriceV">â€”</div>
        <div class="t">IR ç›˜å‰ä»·ï¼ˆæŒ‰FDV2äº¿è¿›è¡Œä¼°ç®— å¯æ‰‹åŠ¨ä¿®æ”¹ä»£å¸ä»·æ ¼ï¼‰</div>
      </div>
    </div>

    <div class="countdownAuto" id="autoRefreshCountdown">ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼šâ€” ç§’</div>

    <button id="refreshBtn">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
    <div class="updateHint" id="lastUpdateHint">â€”</div>

    <!-- ===== æ•™ç¨‹é“¾æ¥ï¼ˆæŒ‰æˆªå›¾ä½ç½®/é£æ ¼ï¼‰ ===== -->
    <div class="tutorials">
      <a class="tutorial-link"
         href="https://x.com/0xXIAOc/status/1929136552757830056"
         target="_blank"
         rel="noopener"
         title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9.6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>é“¾ä¸Šå€ŸBNBæ•™ç¨‹</span>
      </a>

      <a class="tutorial-link"
         href="https://x.com/0xXIAOc/status/1977584958295392288"
         target="_blank"
         rel="noopener"
         title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9.6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>äº¤æ˜“æ‰€å€ŸBNBæ•™ç¨‹</span>
      </a>

      <a class="tutorial-link"
         href="https://x.com/0xXIAOc/status/2001170933500011009?s=20"
         target="_blank"
         rel="noopener"
         title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
        <span class="ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M10 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8.5 14.5c-1.8-1.2-3-3.2-3-5.5A6.5 6.5 0 0 1 12 2.5 6.5 6.5 0 0 1 18.5 9c0 2.3-1.2 4.3-3 5.5-.9.6-1.5 1.5-1.5 2.5H10c0-1-.6-1.9-1.5-2.5Z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>æå‰æˆæƒæ•™ç¨‹</span>
      </a>
    </div>

    <!-- ===== é»„è‰²æç¤ºæ¡ + é‚€è¯·ç ï¼ˆæŒ‰é’®å›ºå®šæœ€å³ï¼›é‚€è¯·ç åœ¨æŒ‰é’®ä¸‹æ–¹ï¼‰ ===== -->
    <div class="hintBanner">
      <div class="hintLeft">
        <span class="hintPrefix">æç¤ºï¼š</span>
        <span class="hintMsg">ä¸æƒ³ä¹° BNB æ‰¿æ‹…ä¸‹è·Œé£é™©ï¼šå¯ä»¥å‚è€ƒä¸Šé¢å€Ÿ BNB æ•™ç¨‹ã€‚</span>
      </div>

      <div class="hintRight">
        <a class="hintBtn"
           href="https://web3.binance.com/zh-CN/referral?ref=XIAOCC"
           target="_blank"
           rel="noopener"
           title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">
          å¸å®‰é’±åŒ…ç»‘å®šé‚€è¯·ç  æ‰‹ç»­è´¹ç«‹å‡30%
        </a>

        <div class="hintSub">
          ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç»‘å®šé‚€è¯·ç <br>
          <span class="hintCode">é‚€è¯·ç ï¼šXIAOCC</span>
        </div>
      </div>
    </div>

    <div class="progress-container" id="progressSection">
      <div class="progress-bg"><div class="progress-bar" id="progressBar"></div></div>
      <div class="countdown" id="countdownText">å€’è®¡æ—¶åŠ è½½ä¸­â€¦</div>
    </div>

    <div class="result" id="resultBox" hidden>
      <p>ğŸ“¦ å½“å‰åœ°å€ BNB ä½™é¢ï¼š<span class="highlight" id="bnbBalance">â€”</span></p>
      <p>ğŸ¯ å‹Ÿé›†ç›®æ ‡ï¼š<span class="highlight" id="targetBNBShow">â€”</span> BNB</p>
      <p>ğŸ”¥ è¶…å‹Ÿå€æ•°ï¼š<span class="highlight" id="multiplier">â€”</span></p>
      <p>ğŸ’° å‡ºå”®ä»£å¸æ•°é‡ï¼š7,500,000 IR ä»£å¸ï¼ˆå æ€»ä¾›åº”é‡çš„ 0.75%ï¼‰</p>
      <hr>
      <p>
        ğŸš€ ä½ æŠ•å…¥ <span class="highlight" id="userInput">â€”</span> BNBï¼ˆå æ¯” <span class="highlight" id="percent">â€”</span>%ï¼‰<br>
        å¯è·å¾— <span class="success" id="tokenAmt">â€”</span> æš IR â‰ˆ <span class="success" id="usdValue">â€”</span>
      </p>
      <p>ğŸ’¸ å®é™…æ‰£æ¬¾ï¼š<span class="deduct" id="principalBNB">â€”</span> BNB â‰ˆ <span class="deduct" id="principalUSD">â€”</span></p>
      <p>ğŸ”„ é€€å› BNBï¼š<span class="refund" id="refundBNB">â€”</span> BNB</p>
    </div>

    <div class="ended-banner" id="endedMsg">æ´»åŠ¨å·²ç»“æŸï¼ŒåŠ¨æ€æ•°æ®å·²éšè—ã€‚</div>
  </div>

  <div class="footer">ä½œè€…ï¼š<a href="https://x.com/0xXIAOc" target="_blank" rel="noopener" title="ç‚¹å‡»å°†è·³è½¬åˆ°ç½‘ç«™">@0xXIAOc</a></div>

  <script>
    // ==== é…ç½®ï¼ˆIR ä¸“åœºï¼‰====
    const CONFIG = {
      SYMBOL: 'IR',
      TOTAL_TARGET_BNB: 174.71,
      TOTAL_TOKENS: 7_500_000,
      MAX_PER_USER_BNB: 3,

      START_TIME: new Date('2025-12-17T16:00:00+08:00'),
      END_TIME:   new Date('2025-12-17T18:00:00+08:00'),

      PRICE_CACHE_MS: 60_000,
      PRICE_DISPLAY_REFRESH_MS: 30_000,

      PRICE_APIS: [
        'https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd',
        'https://min-api.cryptocompare.com/data/price?fsym=BNB&tsyms=USD'
      ],

      RPC_NODES: [
        'https://bsc-dataseed.binance.org/',
        'https://bsc-dataseed1.defibit.io/',
        'https://bsc-dataseed4.defibit.io/',
        'https://bsc-dataseed1.ninicoin.io/'
      ]
    };

    const $ = id => document.getElementById(id);
    const els = {
      userAmount: $('userAmount'),
      tokenPrice: $('tokenPrice'),
      airdropUSD: $('airdropUSD'),
      airdropFmt: $('airdropFmt'),
      refreshSec: $('refreshSec'),
      refreshBtn: $('refreshBtn'),
      lastUpdateHint: $('lastUpdateHint'),
      bnbBalance: $('bnbBalance'),
      multiplier: $('multiplier'),
      userInput: $('userInput'),
      percent: $('percent'),
      tokenAmt: $('tokenAmt'),
      usdValue: $('usdValue'),
      principalBNB: $('principalBNB'),
      principalUSD: $('principalUSD'),
      refundBNB: $('refundBNB'),
      resultBox: $('resultBox'),
      countdownText: $('countdownText'),
      progressBar: $('progressBar'),
      errBanner: $('errBanner'),
      targetAddress: $('targetAddress'),
      targetBNBShow: $('targetBNBShow'),
      bnbPriceV: $('bnbPriceV'),
      labPriceV: $('labPriceV'),
      priceBoxDiv: $('priceBox'),
      autoRefreshCountdown: $('autoRefreshCountdown'),
      endedMsg: $('endedMsg'),
      contractLink: $('contractLink')
    };

    const fmt = (n, d = 0) => Number(n).toLocaleString('zh-CN', { maximumFractionDigits: d });
    const fetchJSON = (u, o) => fetch(u, o).then(r => r.json());
    const TZ = 'Asia/Shanghai';
    const isEnded = () => Date.now() >= CONFIG.END_TIME.getTime();

    function computeAirdropUSDFromTokenPrice(tokenPrice){
      const tokens = CONFIG.TOTAL_TOKENS || 0;
      const price = Number(tokenPrice) || 0;
      return tokens * price;
    }

    function computePrice(){
      const tokenP = +els.tokenPrice.value || 0;
      const computedAirdrop = computeAirdropUSDFromTokenPrice(tokenP);
      els.airdropUSD.value = Math.round(computedAirdrop);
      els.airdropFmt.textContent = computedAirdrop ? ('â‰ˆ ' + fmt(computedAirdrop/1e4) + ' ä¸‡ USDT') : 'â€”';
    }

    function syncLabPriceDisplay(){
      const p = +els.tokenPrice.value || 0;
      els.labPriceV.textContent = p ? (p.toFixed(6) + ' USDT') : 'â€”';
    }

    async function getBNBPrice(){
      const cache = JSON.parse(localStorage.getItem('bnbP')||'{}');
      if(cache.v && Date.now()-cache.t < CONFIG.PRICE_CACHE_MS) return cache.v;

      for(const url of CONFIG.PRICE_APIS){
        try{
          const d = await fetchJSON(url);
          const usd = d?.binancecoin?.usd || d?.USD;
          if(usd){
            localStorage.setItem('bnbP', JSON.stringify({v:usd, t:Date.now()}));
            return usd;
          }
        }catch{}
      }
      return 0;
    }

    async function updatePriceDisplay(){
      try{
        const bnbUSD = await getBNBPrice();
        els.bnbPriceV.textContent = bnbUSD ? ('$' + fmt(bnbUSD,4)) : 'â€”';
        syncLabPriceDisplay();
      }catch(e){
        console.error('updatePriceDisplay error', e);
      }
    }

    function weiHexToBNB(weiHex){
      try{
        const wei = BigInt(weiHex);
        const base = 10n ** 18n;
        const intPart = wei / base;
        const fracPart = wei % base;
        const fracStr = fracPart.toString().padStart(18,'0').slice(0, 6);
        return Number(`${intPart.toString()}.${fracStr}`);
      }catch{
        return 0;
      }
    }

    async function fetchBalance(addr){
      if(!addr) return 0;
      const body = JSON.stringify({jsonrpc:'2.0',method:'eth_getBalance',params:[addr,'latest'],id:1});
      for(const node of CONFIG.RPC_NODES){
        try{
          const {result} = await fetchJSON(node,{method:'POST',headers:{'Content-Type':'application/json'},body});
          return weiHexToBNB(result);
        }catch{}
      }
      return 0;
    }

    let refreshIntervalMs = Math.max(+els.refreshSec.value||10,5) * 1000;
    let nextRefreshSeconds = Math.floor(refreshIntervalMs / 1000);
    let refreshTimerId = null;
    let countdownTimerId = null;

    function startAutoRefreshTimers(){
      if(refreshTimerId) clearInterval(refreshTimerId);
      if(countdownTimerId) clearInterval(countdownTimerId);

      refreshTimerId = setInterval(()=>{ refresh(false); resetCountdown(); }, refreshIntervalMs);
      nextRefreshSeconds = Math.ceil(refreshIntervalMs / 1000);
      updateCountdownDisplay();

      countdownTimerId = setInterval(()=>{
        nextRefreshSeconds--;
        if(nextRefreshSeconds <= 0){
          nextRefreshSeconds = Math.ceil(refreshIntervalMs / 1000);
        }
        updateCountdownDisplay();
      }, 1000);
    }

    function resetCountdown(){
      refreshIntervalMs = Math.max(+els.refreshSec.value||10,5) * 1000;
      nextRefreshSeconds = Math.ceil(refreshIntervalMs / 1000);
      updateCountdownDisplay();
    }

    function updateCountdownDisplay(){
      els.autoRefreshCountdown.textContent = `ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°ï¼š${nextRefreshSeconds} ç§’`;
    }

    let latestDep = 0;

    async function render(dep = latestDep){
      if(isEnded()){ applyEndState(); return; }

      latestDep = dep;
      computePrice();
      syncLabPriceDisplay();

      let user = +els.userAmount.value || 0;
      if(user > CONFIG.MAX_PER_USER_BNB){
        user = CONFIG.MAX_PER_USER_BNB;
        els.userAmount.value = user.toFixed(2);
      }

      const price = +els.tokenPrice.value || 0;
      const bnbUSD = await getBNBPrice();
      const target = CONFIG.TOTAL_TARGET_BNB;

      els.targetBNBShow.textContent = target ? fmt(target,2) : 'â€”';

      if(!(user && price && bnbUSD && dep && target)){
        els.resultBox.hidden = true;
        return;
      }

      const share = user/dep;
      const tokens = share*CONFIG.TOTAL_TOKENS;
      const principal = Math.min(share*target, user);
      const refund = Math.max(user-principal, 0);
      const multi = dep/target;

      els.bnbBalance.textContent = fmt(dep,4);
      els.multiplier.textContent = fmt(multi,2);
      els.userInput.textContent = fmt(user,2);
      els.percent.textContent = fmt(share*100,4);
      els.tokenAmt.textContent = fmt(tokens,2);

      // âœ… è¿™é‡ŒåŠ ä¸Š USD åç¼€ï¼ˆçº¢æ¡†é‚£è¡Œï¼‰
      els.usdValue.textContent = fmt(tokens*price,2) + ' USD';

      els.principalBNB.textContent = fmt(principal,4);
      els.principalUSD.textContent = fmt(principal*bnbUSD,2);
      els.refundBNB.textContent = fmt(refund,4);
      els.resultBox.hidden = false;
    }

    let refreshing=false;
    async function refresh(manual=false){
      if(refreshing) return;
      if(isEnded()){ applyEndState(); return; }

      refreshing=true;
      els.refreshBtn.disabled=true;
      if(manual) els.errBanner.style.display='none';

      try{
        await updatePriceDisplay();
        const dep = await fetchBalance(els.targetAddress.value);
        await render(dep);
        els.lastUpdateHint.textContent='æœ€åæ›´æ–°ï¼š'+new Date().toLocaleTimeString('zh-CN',{hour12:false});
      }catch(e){
        if(manual){
          els.errBanner.textContent=e?.message||'ç½‘ç»œé”™è¯¯';
          els.errBanner.style.display='block';
        }
        console.error(e);
      }finally{
        els.refreshBtn.disabled=false;
        refreshing=false;
      }
    }

    function formatRangeForCN(st, et){
      const getNum = (date, opt) =>
        new Intl.DateTimeFormat('zh-CN', { timeZone: TZ, ...opt })
          .format(date).replace(/\D/g, '');
      const m = getNum(st, { month: 'numeric' });
      const d = getNum(st, { day: 'numeric' });
      const tFmt = new Intl.DateTimeFormat('zh-CN', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false });
      const ts = tFmt.format(st);
      const te = tFmt.format(et);
      return `${m}æœˆ${d}æ—¥ ${ts}-${te}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰`;
    }

    let endStateApplied = false;
    function applyEndState(){
      if(endStateApplied) return;
      endStateApplied = true;

      if(refreshTimerId) clearInterval(refreshTimerId);
      if(countdownTimerId) clearInterval(countdownTimerId);

      els.resultBox.hidden = true;
      els.priceBoxDiv.style.display = 'none';
      els.autoRefreshCountdown.style.display = 'none';
      els.refreshBtn.classList.add('muted');
      els.refreshBtn.disabled = true;
      els.refreshSec.disabled = true;
      els.userAmount.disabled = true;
      els.endedMsg.style.display = 'block';
      els.countdownText.textContent = 'å·²ç»“æŸ';
    }

    function tick(){
      const stMs = CONFIG.START_TIME.getTime();
      const etMs = CONFIG.END_TIME.getTime();
      const nowMs = Date.now();

      if(nowMs < stMs){
        $('countdownText').textContent = `æ´»åŠ¨æœªå¼€å§‹ï¼š${formatRangeForCN(CONFIG.START_TIME, CONFIG.END_TIME)}`;
        $('progressBar').style.width = '0%';
        return;
      }
      if(nowMs >= etMs){
        $('progressBar').style.width = '100%';
        applyEndState();
        return;
      }

      const diff = etMs - nowMs;
      const hours = Math.floor(diff/3.6e6);
      const mins  = Math.floor((diff%3.6e6)/6e4);
      const secs  = Math.floor((diff%6e4)/1e3);
      const txt = hours>0 ? `${hours} å°æ—¶ ${mins} åˆ†` : (mins>0 ? `${mins} åˆ† ${secs} ç§’` : `${(diff/1e3).toFixed(1)} ç§’`);

      $('countdownText').textContent = `å‰©ä½™æ—¶é—´ï¼š${txt}`;
      const pct = ((nowMs - stMs) / (etMs - stMs) * 100);
      $('progressBar').style.width = (pct>100?100: pct<0?0:pct).toFixed(2) + '%';
    }

    function applyInterval(){
      const sec = Math.max(+els.refreshSec.value||10,5);
      refreshIntervalMs = sec * 1000;

      if(refreshTimerId) clearInterval(refreshTimerId);
      if(countdownTimerId) clearInterval(countdownTimerId);

      if(!isEnded()){
        startAutoRefreshTimers();
      }
    }

    els.tokenPrice.addEventListener('input', ()=>{
      els.tokenPrice.dataset.userEdited = '1';
      computePrice();
      syncLabPriceDisplay();
      render();
    });

    els.userAmount.addEventListener('input',()=>{
      let v = +els.userAmount.value || 0;
      if(v > CONFIG.MAX_PER_USER_BNB){
        v = CONFIG.MAX_PER_USER_BNB;
        els.userAmount.value = v.toFixed(2);
      }
      render();
    });

    els.refreshSec.addEventListener('change',applyInterval);
    els.refreshBtn.addEventListener('click',async ()=>{ await refresh(true); resetCountdown(); });

    document.addEventListener('visibilitychange',()=>{
      if(document.hidden){
        clearInterval(refreshTimerId);
        clearInterval(countdownTimerId);
      }else{
        if(!isEnded()) startAutoRefreshTimers();
      }
    });

    window.addEventListener('load', async ()=>{
      const addr = els.targetAddress.value;
      if(els.contractLink){
        els.contractLink.href = `https://bscscan.com/address/${addr}`;
        els.contractLink.textContent = addr;
      }

      computePrice();
      syncLabPriceDisplay();
      await updatePriceDisplay();

      if(!isEnded()){
        startAutoRefreshTimers();
      }
      await refresh();
      setInterval(tick, 500);

      setInterval(()=>{ if(!isEnded()) updatePriceDisplay(); }, CONFIG.PRICE_DISPLAY_REFRESH_MS);
    });
  </script>
</body>
</html>
